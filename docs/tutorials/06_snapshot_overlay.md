# 06 - Memory Snapshots & IDA Pro Plugin

This tutorial explains how to use zelos to create memory snapshots and import them into IDA Pro using the zelos IDA plugin.

## Overview

The Snapshotter Plugin provides the ability to create memory "snapshots", which include:
  * Memory contents of all memory regions
  * Optionally, Instruction-level comments for all executed instructions

When instruction-level comments are included, memory snapshots can then be imported into IDA Pro using the zelos IDA plugin, described below, to highlight the exact behavior of the emulated executable.

## Creating Snapshots

Snapshots can be created using zelos from either the command line or in a script.

### Command Line Use

A snapshot can be generated by using the `--snapshot` flag on the command line. The following command will emulate the executable `my_binary` normally, and upon completion will write a memory snapshot to the file `my_binary.zmu`.

```console
$ zelos my_binary --snapshot
```

To include instruction-level comments in the snapshot, it is required to include the flag `-vv` to enable _verbose_ mode. For an additional speedup, the `--fasttrace` flag can be included in addition to `-vv`, which restricts verbose comment generation to only the first time an address is executed.

```console
$ zelos my_binary --snapshot -vv --fasttrace
```

### Script Use

A snapshot can also be generated when using zelos as a library in scripts by interacting with the `snapshotter` plugin directly. The following shows an example of creating a snapshot dynamically in a script.

```python
# Generating a snapshot by invoking the snapshotter
# plugin directly.
from zelos import Zelos

z = Zelos("/path/to/my_binary")
z.start()

# After emulation finishes

# Open a new file for writing a snapshot
with open("snapshot.zmu", "w") as f:
    # Create a snapshot
    z.plugins.snapshotter.snapshot(f)
```

To include instruction-level comments in the snapshot, again be sure to enable _verbose_ mode by including `-vv` (and optionally `fasttrace=True`) in the Zelos constructor.

```python
from zelos import Zelos

z = Zelos(
    "/path/to/my_binary",
    "-vv", # include instruction-level comments
    fasttrace=True,
)
z.start()

# After emulation finishes

# Open a new file for writing a snapshot
with open("snapshot.zmu", "w") as f:
    # Create a snapshot
    z.plugins.snapshotter.snapshot(f)
```

### Interacting With Snapshots

Snapshots are formatted as ordinary json documents prepended with `DISAS\n` on the first line, so they can be parsed loaded with standard json libraries. The following example demonstrates generating a snapshot with comments, and then using `json.loads` to load it and get the number of memory regions and instruction comments.

```python
import json
from zelos import Zelos

z = Zelos(
    "tests/data/static_elf_helloworld",
    "-vv", # include instruction-level comments
    fasttrace=True,
)
z.start()

# After emulation finishes

# Open a new file for writing a snapshot
f = open("snapshot.zmu", "w+")

# Create a snapshot
z.plugins.snapshotter.snapshot(f)

# Reset seek position
f.seek(0)

# Read the snapshot file, skipping 'DISAS\n'
data = f.read()[len('DISAS\n'):]

# Load the json data
snapshot = json.loads(data)

# Number of memory regions
print(len(snapshot["sections"]))
# Number of instruction comments
print(len(snapshot["comments"]))
```

## Zelos Overlay IDA Plugin

After generating a memory snapshot with instruction-level, it can be imported into IDA Pro using the zelos IDA plugin (which you can get [here](https://raw.githubusercontent.com/zeropointdynamics/zelos/master/src/zelos/ext/plugins/snapshot/zelos_ida.py)). The zelos IDA plugin will highlight the IDA View to indicate which addresses were actually emulated, as well as annotate each address with a comment describing the operation and operand values.

### Installing the IDA Plugin

The plugin source can be viewed and manually downloaded from [here](https://raw.githubusercontent.com/zeropointdynamics/zelos/master/src/zelos/ext/plugins/snapshot/zelos_ida.py). To install, save this file into your IDA Pro install location's `plugins/` directory. On windows, this will typically be something like `C:\Program Files\IDA 7.0\plugins\`. On linux, this will typically be `<ida_install_dir>/plugins/`.

If you would instead prefer a script, if you are using windows, modify the following powershell command for your IDA install location:

```console
wget "https://raw.githubusercontent.com/zeropointdynamics/zelos/master/src/zelos/ext/plugins/snapshot/zelos_ida.py" -outfile "C:\Program Files\IDA 7.0\plugins\zelos_ida.py"
```

If you are using linux, modify the following bash command for your IDA install location:

```console
wget https://raw.githubusercontent.com/zeropointdynamics/zelos/master/src/zelos/ext/plugins/snapshot/zelos_ida.py -O <ida_install_dir>/plugins/zelos_ida.py
```

### Using the IDA Plugin

First, we are going to use zelos to emulate an executable and generate a snapshot with comments. The executable that we are emulating is a basic "hello world", statically-compiled, ELF binary which can be found in the repo [here](https://github.com/zeropointdynamics/zelos/blob/master/tests/data/static_elf_helloworld).

```python
from zelos import Zelos

z = Zelos(
    "static_elf_helloworld",
    "-vv", # include instruction-level comments
    fasttrace=True,
)
z.start()

# After emulation finishes

# Open a new file for writing a snapshot
with open("snapshot.zmu", "w") as f:
    # Create a snapshot
    z.plugins.snapshotter.snapshot(f)
```

After generating a snapshot (with comments), go ahead and open `static_elf_helloworld` in IDA Pro for disassembly. Wait for IDA to load the executable and the finish the initial autoanalysis. Once this completes, assuming you installed the zelos IDA plugin correctly, you should be able to see a View menu option that says "Load Zelos Overlay...". Click on this, and when prompted, navigate to and select the `snapshot.zmu` snapshot file that we generated above.

After a moment, you will notice that the IDA View has been updated. The yellow highlighting indicates an operation that has been emulated in zelos, and the updated comment string at each address describes the value of the emulated operands.
